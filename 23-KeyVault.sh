#!/bin/bash

# Create the directory if it doesn't exist
mkdir -p ./23/

# Function to list all key vaults
list_keyvaults() {
    echo "Listing all Key Vaults..."
    az keyvault list --query '[].name' --output tsv > ./23/keyvault_list.txt
    if [[ -s ./23/keyvault_list.txt ]]; then
        echo "Key Vaults saved to ./23/keyvault_list.txt"
    else
        echo "No Key Vaults found."
        exit 1
    fi
    cat ./23/keyvault_list.txt
}

# Function to list secrets in a selected Key Vault with URI
list_secrets_with_uri() {
    read -p "Enter the Key Vault name: " VAULT_NAME
    echo "Listing secrets and their URIs from Key Vault: $VAULT_NAME"
    az keyvault secret list --vault-name "$VAULT_NAME" --query '[].{Name:name, URI:id}' --output table | tee ./23/"$VAULT_NAME"_secrets.txt
    if [[ -s ./23/"$VAULT_NAME"_secrets.txt ]]; then
        echo "Secrets saved to ./23/${VAULT_NAME}_secrets.txt"
    else
        echo "No secrets found for Key Vault: $VAULT_NAME"
    fi
}

# Main script execution
echo "Azure Key Vault Management"
list_keyvaults

read -p "Do you want to view secrets for a specific Key Vault? (y/n): " choice
if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
    list_secrets_with_uri
else
    echo "Exiting..."
    exit 0
fi
