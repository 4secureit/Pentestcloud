#!/bin/bash

# Function to list all Key Vaults available to the current Azure account
list_keyvaults() {
    echo "Listing available Azure Key Vaults..."
    az keyvault list --query '[].name' --output tsv
}

# Function to set policy for a specific Key Vault
set_keyvault_policy() {
    read -p "Enter Key Vault name: " VAULT_NAME
    read -p "Enter your UPN (e.g., user@domain.com): " UPN
    echo "Setting policy for Key Vault: $VAULT_NAME"
    az keyvault set-policy --name "$VAULT_NAME" --upn "$UPN" --secret-permissions get list --key-permissions get list --storage-permissions get list --certificate-permissions get list
}

# Function to list secrets from a specific Key Vault
list_keyvault_secrets() {
    read -p "Enter Key Vault name: " VAULT_NAME
    echo "Listing secrets for Key Vault: $VAULT_NAME"
    az keyvault secret list --vault-name "$VAULT_NAME" --query '[].id' --output tsv
}

# Function to retrieve a specific secret from Key Vault
show_keyvault_secret() {
    read -p "Enter the URI of the secret: " SECRET_URI
    echo "Retrieving secret..."
    az keyvault secret show --id "$SECRET_URI" | ConvertFrom-Json
}

# Function to invite a guest user to the tenant
invite_guest_user() {
    read -p "Enter the email address of the guest user to invite: " INVITE_EMAIL
    Body="{'invitedUserEmailAddress':'$INVITE_EMAIL', 'inviteRedirectUrl': 'https://portal.azure.com'}"
    echo "Inviting guest user: $INVITE_EMAIL"
    az rest --method POST --uri https://graph.microsoft.com/v1.0/invitations --headers "Content-Type=application/json" --body "$Body"
}

# Display menu options for the user
display_menu() {
    echo "Select an action to perform:"
    echo "1. List Key Vaults"
    echo "2. Set Key Vault policy"
    echo "3. List secrets from a Key Vault"
    echo "4. Show specific secret from Key Vault"
    echo "5. Invite a guest user"
    echo "q. Quit"
}

# Main script logic
while true; do
    display_menu
    read -p "Enter your choice: " CHOICE
    case "$CHOICE" in
        1) list_keyvaults ;;
        2) set_keyvault_policy ;;
        3) list_keyvault_secrets ;;
        4) show_keyvault_secret ;;
        5) invite_guest_user ;;
        q) echo "Exiting..." ; exit 0 ;;
        *) echo "Invalid choice. Please select a valid option." ;;
    esac
done
