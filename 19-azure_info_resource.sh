#!/bin/bash

# Function to check if the ./19/ directory exists, if not, create it
create_directory() {
    if [ ! -d "./19/" ]; then
        echo "Directory ./19/ does not exist. Creating it..."
        mkdir -p ./19/
    else
        echo "Directory ./19/ already exists."
    fi
}

# Function to check if an Azure session is active
check_session() {
    az account show &> /dev/null
    if [ $? -eq 0 ]; then
        echo "An active Azure session is already present."
        display_session_info
    else
        echo "No active Azure session found."
        display_login_options
    fi
}

# Function to display Azure login options
display_login_options() {
    echo "Please choose one of the login options below:"
    echo "-------------------------------------------"
    echo "1. Log in using a device code (browser-based login):"
    echo "   az login --use-device-code"
}

# Function to display information about the current session, save to files, and group resources
display_session_info() {
    echo "Fetching Azure resource list..."
    
    # Ensure the directory exists
    create_directory
    
    # Get the resource list and save it to ./19/resource.txt
    az resource list > ./19/resource.txt
    echo "Resource list saved to ./19/resource.txt"
    
    # Group resources by Resource Group and Name and save to ./19/group_resource.txt
    echo "Grouping resources by Resource Group and Name..."
    
    # Extract and group by Resource Group and Name
    awk 'BEGIN { RS="\\n"; FS=""; OFS="\\t" }
    /\"resourceGroup\":/ { 
        if (group != "" && group != $2) {
            print "Resource Group: " group "\n" buffer "\n"
            buffer = ""
        }
        group = $2
    }
    {
        buffer = buffer (buffer ? "\n" : "") $0
    }
    END {
        if (buffer) {
            print "Resource Group: " group "\n" buffer "\n"
        }
    }' ./19/resource.txt > ./19/group_resource.txt
    
    # Display grouped resources in table format
    echo "Grouped resources saved to ./19/group_resource.txt"
    cat ./19/group_resource.txt
}

# Main script execution
check_session
